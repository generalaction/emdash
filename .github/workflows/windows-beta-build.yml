name: Windows Beta Build

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to build (branch, tag, or SHA)'
        required: true
        default: 'windows-beta'

permissions:
  contents: read

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Ensure Windows SDK
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $kits = "${env:ProgramFiles(x86)}\Windows Kits\10\Include"
          if (Test-Path $kits) {
            Write-Host "Windows SDK already present at: $kits"
            exit 0
          }

          $vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          if (!(Test-Path $vswhere)) {
            throw "vswhere.exe not found at $vswhere"
          }

          $installPath = & $vswhere -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath
          if (!$installPath) {
            throw "Visual Studio installation not found"
          }

          $installer = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vs_installer.exe"
          if (!(Test-Path $installer)) {
            throw "vs_installer.exe not found at $installer"
          }

          $components = @(
            "Microsoft.VisualStudio.Component.Windows11SDK.22621",
            "Microsoft.VisualStudio.Component.Windows11SDK.22000",
            "Microsoft.VisualStudio.Component.Windows10SDK.22621",
            "Microsoft.VisualStudio.Component.Windows10SDK.20348",
            "Microsoft.VisualStudio.Component.Windows10SDK.19041",
            "Microsoft.VisualStudio.Component.Windows10SDK.18362",
            "Microsoft.VisualStudio.Component.Windows10SDK.17763"
          )

          foreach ($c in $components) {
            Write-Host "Attempting to add SDK component: $c"
            & $installer modify --installPath "$installPath" --add $c --quiet --norestart --nocache | Out-Host
            if (Test-Path $kits) { break }
          }

          if (!(Test-Path $kits)) {
            throw "Windows SDK not found after attempting install. Expected: $kits"
          }
          Write-Host "Windows SDK installed at: $kits"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          # Node 22 can trigger native module source builds that are flakier on Windows.
          # Node 20 is within engines range and closer to Electron's Node baseline.
          node-version: '20'
          cache: 'pnpm'

      - name: Setup Python 3.11 for node-gyp
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python build deps (setuptools shim for distutils)
        shell: bash
        run: |
          python -m pip install --upgrade pip setuptools wheel
          echo "python=$(which python)" >> "$GITHUB_ENV"

      - name: Install dependencies (strict lockfile)
        shell: bash
        env:
          npm_config_python: ${{ env.python }}
          npm_config_msvs_version: 2022
          GYP_MSVS_VERSION: 2022
        run: pnpm install --frozen-lockfile

      - name: Build app (ts + vite)
        shell: bash
        run: pnpm run build

      - name: Rebuild native modules (x64)
        shell: bash
        run: |
          set -euo pipefail
          ELECTRON_VERSION=$(node -p "require('electron/package.json').version")
          npm_config_build_from_source=true pnpm exec electron-rebuild -f -a x64 -v "$ELECTRON_VERSION" -o sqlite3,node-pty,keytar

      - name: Package Windows (NSIS + MSI) (no publish)
        shell: bash
        run: |
          set -euo pipefail
          pnpm exec electron-builder --win nsis msi --x64 --publish never --config.npmRebuild=false
          ls -lah release || true

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: WINDOWS-BETA-BUILD
          path: |
            release/emdash-*.exe
            release/emdash-*.msi
            release/*.blockmap
            release/latest*.yml
          if-no-files-found: error
